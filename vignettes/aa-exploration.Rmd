---
title: "aa-exploration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{aa-exploration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(evavelo)
library(openxlsx)
library(magrittr)
library(stringr)
library(dplyr)
library(janitor)
```

Dans ce document, je vais charger un fichier excel et appliqué la méthodologie pour corriger la catégorie cycliste.

## Import du fichier Excel
```{r import and clean data}
# Full data
xlsx_path <- system.file("example-data/01_all.xlsx", package = "evavelo")
# Reduced size data
#xlsx_path <- system.file("example-data/02_simplified.xlsx", package = "evavelo")
#xlsx_path <- here::here("inst", "example-data", "02_simplified.xlsx")

## List of expected values 
cat_list <- c("Sportif", "Itinérant", "Utilitaire", "Loisir")
type_sortie_list <- c("Une heure ou deux",
                      "Demi-journée",
                      "Journée",
                      "Plusieurs jours")

## Sheet: Comptage Post Traitements
comptage_post <- openxlsx::read.xlsx(xlsx_path,
                                     sheet = "comptages_man_post_traitements")

comptage_post <- comptage_post %>% 
  select(starts_with("[")) %>%  ## Don't take in account "old" col names that could create duplicated entries
  janitor::clean_names() %>% 
  mutate(categorie_breve = as.character(categorie_breve))

## Sheet: Enquetes Post Traitements
enquete_post <- openxlsx::read.xlsx(xlsx_path,
                                    sheet = "enquetes_post_traitement")
enquete_post <- enquete_post %>% 
  janitor::clean_names()
  

```

## Application de la méthodologie pour déterminer [categorie_corrige]

Il s'agit aussi du champ [categorie_visuelle_cycliste_corrige] dans les comptages

Se référer au chapitre 3.1.11 de la méthodologie EVA-Velo:


### Recherche des incohérence
Recherche de réponses incohérentes entre [categorie] (enquetes) et [categorie_visuelle_cyclistes] (comptage)

```{r error checking}
## Keep only necessary fields from enquete

## Look at categories from "comptage"
comptage_post %>% 
  filter(!is.na(categorie_visuelle_cycliste)) %>% 
  select(id_quest,
         starts_with("categorie"))

## Search for categorie_breve
comptage_post %>% 
  filter(!is.na(categorie_breve))

## Check for question answered but no visual category cyclist (anomaly)
## Vérifié avec Stephanie, il s'agit d'etudes spécifiques sur piétons qu'il faut ignorer dans mon analyse
comptage_post %>% 
  select(id_quest,categorie_visuelle_cycliste, categorie_breve) %>% 
  left_join(select(enquete_post, id_quest, categorie), 
            by = "id_quest") %>% 
  filter(is.na(categorie) == FALSE & is.na(categorie_visuelle_cycliste))

## Check for  cyclist categories that are not in the expected list
comptage_post %>% 
  filter(!is.na(categorie_visuelle_cycliste)) %>% 
  filter(!categorie_visuelle_cycliste %in% cat_list) %>% 
  count(categorie_visuelle_cycliste)

# Warning Loisirs is used instead of Loisir.... correcting by removing trailing (s) in table
comptage_post <- comptage_post %>% 
  mutate(categorie_visuelle_cycliste = stringr::str_remove(categorie_visuelle_cycliste,
                                                           "s$"))
comptage_post %>% 
  filter(!is.na(categorie_breve)) %>% 
  filter(!categorie_breve %in% cat_list) %>% 
  count(categorie_breve)

enquete_post %>% 
  filter(!categorie %in% cat_list)

## Check for type_sortie 
enquete_post %>% 
  filter(!type_sortie %in% type_sortie_list) %>% 
  count(type_sortie)


enquete_post <- enquete_post %>% 
  mutate(
    type_sortie = case_when(
      type_sortie == "Demi journée" ~ "Demi-journée",
      type_sortie == "La journée" ~ "Journée",
      TRUE ~ type_sortie)
    )

```
### Correction des catégories dans comptage
```{r categorie_visuelle_cycliste_corrige}
comptage_post %>% 
  mutate(categorie_visuelle_cycliste_corrige = coalesce(categorie_breve, ## chapter 3.1.12.2 categorie_breve override categorie_visuelle_cycliste
                                                        categorie_visuelle_cycliste)) %>% 
  select(starts_with("categ"))
```
### Correction des categories dans enquete
Il y a 12 cas de figure décrit dans le chapitre 3.1.11 de la méthodologie

```{r categorie_corrigee}

## keep only needed informations

enquete <- enquete_post %>% 
  select(id_quest, categorie, categorie_corrige,
         type_sortie, dms, starts_with("iti_")) %>% 
  left_join(select(comptage_post, 
                   id_quest, categorie_visuelle_cycliste),
            by = "id_quest") %>% 
  filter(!is.na(categorie_visuelle_cycliste)) ##Delete enquete on non-cyclists (https://github.com/JMPivette/evavelo/discussions/3)


## find differences between categorie and categorie_visuelle_cycliste
cat_to_correct <- enquete %>% 
  filter(categorie != categorie_visuelle_cycliste) 

cat_to_correct%>% 
  count(categorie, categorie_visuelle_cycliste)

```
#### Cas 1

```{r cas 1}
cat_to_correct %>% 
  filter(categorie == "Sportif" & categorie_visuelle_cycliste =="Itinérant")

cat_to_correct %>% 
  filter(categorie == "Sportif" & categorie_visuelle_cycliste =="Itinérant") %>% 
  #mutate(iti_test = c(1,NA,2,NA,3,NA)) %>% ## For tests (because there was no responses to iti in the example)
  mutate(iti_any = rowSums(across(starts_with("iti"), ~ !is.na(.x))) != 0) %>%  ## check if any response from Q25 to Q27
  mutate(
    categorie_corrige = 
      case_when(
        iti_any ~ "Itinérant",
        type_sortie == "Plusieurs jours" & dms > 1 ~ "Itinérant",
        TRUE ~ "Sportif"
      ))  
         

```

Attention j'ai des sportifs qui se transforment en loisir dans les fichier Excel avec les catégories corrigées

#### Cas 2

En fait le cas 2 est exactement le même algorithme que le cas 1 (en remplaçant sportif par utilitaire)


```{r cas 2}
cat_to_correct %>% 
  filter(categorie == "Utilitaire" & categorie_visuelle_cycliste =="Itinérant")

cat_to_correct %>% 
  filter(categorie == "Utilitaire" & categorie_visuelle_cycliste =="Itinérant") %>% 
  mutate(iti_any = rowSums(across(starts_with("iti"), ~ !is.na(.x))) != 0) %>%  ## check if any response from Q25 to Q27
  mutate(
    categorie_corrige = 
      case_when(
        iti_any ~ "Itinérant",
        type_sortie == "Plusieurs jours" & dms > 1 ~ "Itinérant",
        TRUE ~ "Utilitaire"
      ))  

```

#### Cas 3

On est encore sur le même algorithme que les cas 1 et cas 2.
Attention il y a une subtilité dans la methodologie "Réponses cohérentes"

```{r}
cat_to_correct %>% 
  filter(categorie == "Loisir" & categorie_visuelle_cycliste =="Itinérant")

cat_to_correct %>% 
  filter(categorie == "Loisir" & categorie_visuelle_cycliste =="Itinérant") %>% 
  mutate(iti_any = rowSums(across(starts_with("iti"), ~ !is.na(.x))) != 0) %>%  ## check if any response from Q25 to Q27
  mutate(
    categorie_corrige = 
      case_when(
        iti_any ~ "Itinérant",
        type_sortie == "Plusieurs jours" & dms > 1 ~ "Itinérant",
        TRUE ~ "Loisir"
      ))  

```

#### Cas 1 2 & 3

L'algorithmie est identique sur les 3 premiers cas qui correspondent à une categorie visuelle "Itinérant" là ou le questionnaire indique autre chose

On peut donc le faire en une seule passe

```{r}
cat_to_correct %>% 
  filter(categorie_visuelle_cycliste =="Itinérant" & categorie != "Itinérant") %>% 
  mutate(iti_any = rowSums(across(starts_with("iti"), ~ !is.na(.x))) != 0) %>%  ## check if any response from Q25 to Q27
  mutate(
    categorie_corrige = 
      case_when(
        iti_any ~ "Itinérant",
        type_sortie == "Plusieurs jours" & dms > 1 ~ "Itinérant",
        TRUE ~ categorie
      ))  

```



#### Cas 4

```{r}
cat_to_correct %>% 
  filter(categorie == "Itinérant" & categorie_visuelle_cycliste =="Sportif")

cat_to_correct %>% 
  filter(categorie == "Itinérant" & categorie_visuelle_cycliste =="Sportif") %>% 
  mutate(iti_any = rowSums(across(starts_with("iti"), ~ !is.na(.x))) != 0) %>%  ## check if any response from Q25 to Q27
  mutate(
    categorie_corrige = 
      case_when(
        iti_any ~ "Itinérant",
        type_sortie == "Plusieurs jours" & dms > 1 ~ "Itinérant",
        TRUE ~ "Sportif"
      ))  
```

Attention, j'ai un cas pour lequel la dms n'est pas renseignée (questionnaire 115A11). Cela le classifie en Sportif alors que de toute évidence il est Itinérant.
